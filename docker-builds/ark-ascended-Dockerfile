# HostMachine ARK: Survival Ascended (Wine Core)
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies and WineHQ Staging
RUN dpkg --add-architecture i386 && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    gnupg \
    software-properties-common \
    && mkdir -pm755 /etc/apt/keyrings \
    && curl -fsSL https://dl.winehq.org/wine-builds/winehq.key -o /etc/apt/keyrings/winehq-archive.key \
    && curl -fsSL https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/winehq-jammy.sources -o /etc/apt/sources.list.d/winehq-jammy.sources \
    && apt-get update && \
    apt-get install -y --install-recommends \
    winehq-staging \
    xvfb \
    lib32gcc-s1 \
    nodejs \
    npm \
    libsdl2-2.0-0 \
    procps \
    libvulkan1 \
    libvulkan1:i386 \
    mesa-vulkan-drivers \
    mesa-vulkan-drivers:i386 \
    libxcomposite1 \
    libxcursor1 \
    libxi6 \
    libxtst6 \
    libfontconfig1 \
    libasound2 \
    winetricks \
    && rm -rf /var/lib/apt/lists/*

# Create steam user
RUN groupadd -g 1001 steam && \
    useradd -u 1001 -g steam -m steam

# Setup directories
RUN mkdir -p /home/steam/steamcmd /data && \
    chown -R steam:steam /home/steam /data

USER steam
WORKDIR /home/steam

# Download SteamCMD
RUN cd /home/steam/steamcmd && \
    curl -sL https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz | tar -xvz

WORKDIR /data

COPY --chmod=755 ark-ascended-entrypoint.sh /entrypoint.sh
COPY runner.js /runner.js

EXPOSE 7777/udp 27015/udp

USER root
RUN chmod +x /entrypoint.sh
USER steam

ENV PATH="/opt/wine-staging/bin:${PATH}"
ENV GAME_COMMAND="bash /entrypoint.sh"
ENTRYPOINT ["node", "/runner.js"]